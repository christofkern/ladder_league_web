<!DOCTYPE html>
<html>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='styles_layout2P.css') }}">


<body class="layout2P" width=1920px height=1080px>
    <div id="name1" class="runnername"></div>
    <div id="name2" class="runnername"></div>

    <div id="delta1" class="delta"></div>
    <div id="delta2" class="delta"></div>
    
    
<div class="statistics">
    <div id="carouselExampleSlidesOnly" class="carousel slide" data-bs-ride="false"  style="width:100%">
        <div class="carousel-inner" id="carousel-inner">   	
            <!-- Initial Slide -->
            <div class="carousel-item active">
                <div class="pt-4 carousel-header">Loading...</div>
            </div>
        </div>
    </div>
</div>

<!--
</div>
    <div class="commentators">
        <div class="block" style="height: 100%;">            
            <div class="centered" id="cbox">
                <div class="child">
                    P53
                </div>
            </div>            
        </div>
    </div>
</div>

<div class="timer" id="main_timer">
   
00:00:00
</div>
 -->
</body>

<div class="overlay-p1 invisible">       
    <p id="overlay-p1" class="overlay-text"></p>    
</div>

<div class="overlay-p2 invisible">       
    <p id="overlay-p2"  class="overlay-text"></p>    
</div>


<script>

    let s_id = "{{spreadsheet_id}}";
    let race_name = ""
    let runner1 = ""
    let runner2 = ""

    function setTitleAndRunners(){
        fetch('/static_info?spreadsheet_id=' + encodeURIComponent(s_id))
            .then(response => response.json())
                .then(data => {      
                    //check if there is an entry error, if not extract the entries 'racename', 'runners', 'country_urls'. The both last are arrys in python
                    if (data.error) {
                        console.error("Error in data:", data.error);
                    } else {
                        const racename = data[0].racename;
                        const runners = data[1].runners;
                        const country_urls = data[2].country_urls;

                        race_name = racename
                        runner1 = runners[0].substring(runners[0].indexOf(" "));
                        runner2 = runners[1].substring(runners[0].indexOf(" "));

                        for (var i = 0; i < Math.min(3, runners.length); i++) {
                            var fieldName = 'name' + (i + 1);
                            document.getElementById(fieldName).innerHTML = runners[i] + '&nbsp<img src="' + country_urls[i] + '" style="width: 64px">'
                        }

                        //initialize the carousel from here
                        initializeCarousel();

                    }
                })
        .catch(error => {
            console.error("Error fetching static info", error);
        });
    }

    function updateDeltas(){
        fetch('/runner_deltas?spreadsheet_id=' + encodeURIComponent(s_id))
            .then(response => response.json())
                .then(data => {   
                    if (data.error) {
                        console.error("Error in data:", data.error);
                    } else {
                        const deltas = data.runner_deltas;
                        for (var i = 0; i < Math.min(3, deltas.length); i++) {
                            var fieldName = 'delta' + (i + 1);
                            document.getElementById(fieldName).innerHTML = deltas[i]
                        }
                    }
                    //do it again in 20s
                    setTimeout(updateDeltas, 10000)
                });            
    }

    function initializeCarousel(){
        const carouselInner = document.getElementById('carousel-inner');
        const newSlide = `
                <div class="carousel-item active">
                    <div class="pt-4 carousel-racename">${race_name}</div>
                    <div class='pt-3 carousel-commands'>                                        
                        <b>!bracket !runners !discord !tech</b>
                        <br>
                        <b>!schedule !predictions </b>
                    </div>
                </div>
            `;
        carouselInner.innerHTML = newSlide;
        setTimeout(goPBSlide, 2000);
    }

    function goNextSlide() {
        $('#carouselExampleSlidesOnly').carousel('next');        
    }

    function goPBSlide(){
        fetch('/runner_pbs?spreadsheet_id=' + encodeURIComponent(s_id))
            .then(response => response.json())
                .then(data => {   
                    if (data.error) {
                        console.error("Error in data:", data.error);
                        goTournamentStatsSlide();
                    } else {
                        const pbs = data.runner_pbs;
                        
                        const carouselInner = document.getElementById('carousel-inner');
                        const newSlide = `
                            <div id='{idx}' class='carousel-item'>
                                <div class='container' >
                                    <div class='row pt-4 carousel-header'>
                                        <b>PERSONAL BESTS</b>
                                    </div>
                                    <div class='row pt-3 carousel-rows'>
                                        <div class='col-4' carousel-items>
                                            <h3 class='carousel-runner carousel-info'>${runner1}</h3>
                                            <h3 class='carousel-info'>${pbs[0]}</h3>
                                        </div>
                                        <div class='col-4 carousel-items'>
                                            <h3 class='carousel-runner carousel-info'>${runner2}</h3>
                                            <h3 class='carousel-info'>${pbs[1]}</h3>
                                        </div>                                    
                                    </div>
                                </div>
                            </div>
                        `;
                        carouselInner.innerHTML += newSlide;

                        goNextSlide();

                        setTimeout(goTournamentStatsSlide, 12000);
                    }
                    
                });  
    }

    function goTournamentStatsSlide(){
        fetch('/runner_tournamentstats?spreadsheet_id=' + encodeURIComponent(s_id))
            .then(response => response.json())
                .then(data => {   
                    if (data.error) {
                        console.error("Error in data:", data.error);
                        gpBPTSlide();
                    } else {
                        const h2h = data.h2h;
                        const records = data.runner_records;
                        const avgs = data.runner_avgs;
                        
                        const carouselInner = document.getElementById('carousel-inner');
                        const newSlide = `
                            <div id='{idx}' class='carousel-item'>
                                <div class='container' >
                                    <div class='row pt-4 carousel-header-llstats'>
                                        <b>TOURNAMENT STATS</b>
                                    </div>
                                    <div class='row pt-3 carousel-rows'>
                                        <div class='col-4' carousel-items>
                                            <h3 class='carousel-llstats'>&nbsp;</h3>
                                            <h3 class='carousel-runner carousel-info'>RECORD</h3>
                                            <h3 class='carousel-info'>AVERAGE</h3>
                                        </div>
                                        <div class='col-4 carousel-items'>
                                            <h3 class='carousel-llstats'>${runner1}</h3>
                                            <h3 class='carousel-runner carousel-info'>${records[0]}</h3>
                                            <h3 class='carousel-info'>${avgs[0]}</h3>
                                        </div>      
                                        <div class='col-4 carousel-items'>
                                            <h3 class='carousel-llstats'>${runner2}</h3>
                                            <h3 class='carousel-runner carousel-info'>${records[1]}</h3>
                                            <h3 class='carousel-info'>${avgs[1]}</h3>
                                        </div>                                
                                    </div>
                                </div>
                            </div>
                        `;
                        carouselInner.innerHTML += newSlide;

                        goNextSlide();

                        setTimeout(goBPTSlide, 12000);
                    }
                    
                });  
    }

    function goBPTSlide(){
        fetch('/runner_bpts?spreadsheet_id=' + encodeURIComponent(s_id))
            .then(response => response.json())
                .then(data => {   
                    if (data.error) {
                        console.error("Error in data:", data.error);
                        goTournamentStatsSlide();
                    } else {
                        const bpts = data.runner_bpts;
                        
                        const carouselInner = document.getElementById('carousel-inner');
                        const newSlide = `
                            <div id='{idx}' class='carousel-item'>
                                <div class='container' >
                                    <div class='row pt-4 carousel-header'>
                                        <b>BEST POSSIBLE TIME</b>
                                    </div>
                                    <div class='row pt-3 carousel-rows'>
                                        <div class='col-4' carousel-items>
                                            <h3 class='carousel-runner carousel-info'>${runner1}</h3>
                                            <h3 class='carousel-info'>${bpts[0]}</h3>
                                        </div>
                                        <div class='col-4 carousel-items'>
                                            <h3 class='carousel-runner carousel-info'>${runner2}</h3>
                                            <h3 class='carousel-info'>${bpts[1]}</h3>
                                        </div>                                    
                                    </div>
                                </div>
                            </div>
                        `;
                        carouselInner.innerHTML += newSlide;

                        goNextSlide();
                            
                        setTimeout(goSOBSlide, 12000);
                    }
                    
                });  
    }

    function goSOBSlide(){
        fetch('/runner_sobs?spreadsheet_id=' + encodeURIComponent(s_id))
            .then(response => response.json())
                .then(data => {   
                    if (data.error) {
                        console.error("Error in data:", data.error);
                        goTournamentStatsSlide();
                    } else {
                        const sobs = data.runner_sobs;
                        
                        const carouselInner = document.getElementById('carousel-inner');
                        const newSlide = `
                            <div id='{idx}' class='carousel-item'>
                                <div class='container' >
                                    <div class='row pt-4 carousel-header'>
                                        <b>SUM OF BESTS</b>
                                    </div>
                                    <div class='row pt-3 carousel-rows'>
                                        <div class='col-4' carousel-items>
                                            <h3 class='carousel-runner carousel-info'>${runner1}</h3>
                                            <h3 class='carousel-info'>${sobs[0]}</h3>
                                        </div>
                                        <div class='col-4 carousel-items'>
                                            <h3 class='carousel-runner carousel-info'>${runner2}</h3>
                                            <h3 class='carousel-info'>${sobs[1]}</h3>
                                        </div>                                    
                                    </div>
                                </div>
                            </div>
                        `;
                        carouselInner.innerHTML += newSlide;

                        goNextSlide();

                        const randomNumber = Math.floor(Math.random() * 5); // Generates a random number between 0 and 4
                        if (randomNumber === 0) {
                            setTimeout(goFunFactSlide, 12000);
                        } else {
                            setTimeout(goFirstSlide, 12000);
                        }
                    }                    
                });  
    }

    function goFunFactSlide(){
        fetch('/fun_fact?spreadsheet_id=' + encodeURIComponent(s_id))
            .then(response => response.json())
                .then(data => {   
                    if (data.error) {
                        console.error("Error in data:", data.error);
                        goTournamentStatsSlide();
                    } else {
                        const fun_fact = data.fun_fact;
                        
                        const carouselInner = document.getElementById('carousel-inner');
                        const newSlide = `
                            <div class="carousel-item funFact">
                                <div class="container">
                                    <div class="row pt-4 carousel-header">
                                        <b>FUN FACT</b>
                                    </div>
                                    <div class="row pt-3">
                                        <div class="col-12">
                                            <h3>${fun_fact}</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        carouselInner.innerHTML += newSlide;

                        goNextSlide();
                            
                        setTimeout(goFirstSlide, 12000);
                    }
                    
                });  
    
    }

    function goFirstSlide(){        
        const carouselInner = document.getElementById('carousel-inner');
        const newSlide = `
                <div class="carousel-item">
                    <div class="pt-4 carousel-racename">${race_name}</div>
                    <div class='pt-3 carousel-commands'>                                        
                        <b>!bracket !runners !discord !tech</b>
                        <br>
                        <b>!schedule !predictions </b>
                    </div>
                </div>
            `;
        carouselInner.innerHTML += newSlide;

        goNextSlide();

        setTimeout(initializeCarousel, 8000);
    }
    function activateOverlay(index, final_times, results, colors){
        let overlay = document.getElementsByClassName('overlay-p' + (index+1))[0];
        let overlay_text = document.getElementById('overlay-p' + (index+1));
        
        overlay.classList.remove('invisible');
        overlay_text.innerHTML = final_times[index] + '<br>' + results[index]
        overlay_text.style.color = colors[index]
    }


    function updateOverlays(){
        fetch('/check_final?spreadsheet_id=' + encodeURIComponent(s_id))
            .then(response => response.json())
                .then(data => {   
                    let final_times = data.final_times;
                    let results = data.results;
                    let colors = data.text_colors;   
                    
                    final_times.forEach((item,index) => {
                        if (item != '27:46:40'){
                            setTimeout(() => {
                                activateOverlay(index, final_times, results, colors);
                            }, 30000);
                        }
                    })
                    
                })
                .catch(error => {
                    console.error("Error fetching modification time:", error);
            });
    }


    setTitleAndRunners();
    updateDeltas();
    setInterval(updateOverlays, 15000);
    updateOverlays();


</script>

<script>
    /*
    var timer = 0;
    var startDate = null;
    var actualEnd = null;
    
    $( document ).ready(function() {
        setInterval(function() {
            $.ajax({
                url: 'http://10.10.0.221:28010/event?host={{ automarathon_host }}', 
                type: 'GET',
                headers: {'Access-Control-Allow-Origin':'*'}, // <-------- set this
                dataType: 'text', // // <-------- use JSONP
                success: function(data){
                    data = JSON.parse(data);
                    console.log(data)

                    if (data.hasOwnProperty('start_time')) {
		    var startTime = data['start_time']
                    if (startTime == null) {
                        startDate = null
                    } else {
                        startDate = new Date(startTime)
                    }
                    }

                    if(data.hasOwnProperty('end_time')){
                        actualEnd =  data['end_time'] != null ? new Date(data['end_time']) : null;
                    }


                    if (startDate == null) {
                    document.getElementById("main_timer").innerHTML = toTime(0);
                    } else {
                    var endDate = actualEnd == null ? new Date() : actualEnd;
                    var timer = (endDate.getTime() - startDate.getTime());
                    document.getElementById("main_timer").innerHTML = toTime(timer);
                    }
                }
            });
        }, 1000);
    });
    
    $( document ).ready(function() {
        setInterval(function() {
            $.ajax({
    		url: 'http://10.10.0.221:28010/commentators?host={{ automarathon_host }}', 
                type: 'GET',
                headers: {'Access-Control-Allow-Origin':'*'}, // <-------- set this
                dataType: 'text', // // <-------- use JSONP
                success: function(data){
                    data = JSON.parse(data);
    		    setCommentators(data);
                }
            });
        }, 1000);
    });

    function timer() {
    }
    setInterval(timer, 500);
    */
</script>

</html>
